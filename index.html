<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NUMÉRATION-ENTRAINEMENT | Expert Boulier</title>
    
    <!-- Frameworks & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --indigo-600: #4f46e5; --slate-900: #0f172a; }
        body { font-family: 'Inter', sans-serif; background-color: #cbd5e1; min-height: 100vh; margin: 0; }
        .font-space { font-family: 'Space Grotesk', sans-serif; }
        
        /* --- 3D FLIP CARD --- */
        .card-container { perspective: 2000px; height: 100%; min-height: 680px; }
        .card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 1.5rem;
            display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .is-flipped .card-front { visibility: hidden !important; pointer-events: none; }
        .card-back { transform: rotateY(180deg); background: #f8fafc; border: 4px solid white; }

        /* --- ABACUS STYLES --- */
        .bead { transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); cursor: pointer; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        @keyframes pulse-timer {
            0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; }
        }
        .timer-low { animation: pulse-timer 0.5s infinite; }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- HEADER -->
        <header class="bg-slate-900 text-white p-4 md:px-10 flex flex-col lg:flex-row items-center justify-between shadow-2xl z-50 gap-4">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg border-b-4 border-indigo-800">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M3 3h18v18H3zM3 9h18M9 3v18"/></svg>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-black font-space tracking-tighter leading-none uppercase">NUMÉRATION-ENTRAINEMENT</h1>
                    <p class="text-indigo-400 font-bold uppercase tracking-[0.3em] text-[10px] mt-1">CLASSE ADAPTATIVE</p>
                </div>
            </div>
            
            <div class="flex bg-slate-800 p-1 rounded-xl border border-slate-700">
                <button onclick="setNumPlayers(1)" id="btn-mode-1" class="px-5 py-2 rounded-lg text-xs font-black uppercase transition-all">Individuel</button>
                <button onclick="setNumPlayers(2)" id="btn-mode-2" class="px-5 py-2 rounded-lg text-xs font-black uppercase transition-all">Duel</button>
                <button onclick="setNumPlayers(4)" id="btn-mode-4" class="px-5 py-2 rounded-lg text-xs font-black uppercase transition-all">Équipe</button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main id="main-grid" class="flex-1 p-4 grid gap-6 transition-all duration-500">
            <!-- Injecté par JS -->
        </main>
    </div>

<script>
/** 1. LOGIQUE MATHÉMATIQUE **/
const MathUtils = {
    toRoman(n) {
        if (n <= 0 || n > 3999) return "N/A";
        const map = { M:1000, CM:900, D:500, CD:400, C:100, XC:90, L:50, XL:40, X:10, IX:9, V:5, IV:4, I:1 };
        let res = "";
        for (let i in map) { while (n >= map[i]) { res += i; n -= map[i]; } }
        return res;
    },
    toFrench(n) {
        if (n === 0) return "zéro";
        const units = ["", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf"];
        const teens = ["dix", "onze", "douze", "treize", "quatorze", "quinze", "seize", "dix-sept", "dix-huit", "dix-neuf"];
        const tens = ["", "dix", "vingt", "trente", "quarante", "cinquante", "soixante", "soixante-dix", "quatre-vingt", "quatre-vingt-dix"];
        const solve99 = (x) => {
            if (x < 10) return units[x];
            if (x < 20) return teens[x-10];
            const q = Math.floor(x/10), r = x%10;
            if (q === 7) return r === 1 ? "soixante-et-onze" : "soixante-" + teens[r];
            if (q === 8) return r === 0 ? "quatre-vingts" : "quatre-vingt-" + units[r];
            if (q === 9) return "quatre-vingt-" + teens[r];
            if (r === 0) return tens[q];
            if (r === 1 && q < 7) return tens[q] + "-et-un";
            return tens[q] + "-" + units[r];
        };
        const solve999 = (x) => {
            if (x < 100) return solve99(x);
            const c = Math.floor(x/100), r = x%100;
            const cPart = c === 1 ? "cent" : units[c] + "-cent" + (r === 0 ? "s" : "");
            return r === 0 ? cPart : cPart + "-" + solve99(r);
        };
        const solve = (x) => {
            if (x < 1000) return solve999(x);
            if (x < 1000000) {
                const m = Math.floor(x/1000), r = x%1000;
                const mPart = m === 1 ? "mille" : solve999(m) + "-mille";
                return r === 0 ? mPart : mPart + "-" + solve999(r);
            }
            const mio = Math.floor(x/1000000), r = x%1000000;
            const mioPart = solve999(mio) + (mio > 1 ? "-millions" : "-million");
            return r === 0 ? mioPart : mioPart + "-" + solve(r);
        };
        return solve(n).replace(/-+/g, "-").replace(/-$/, "");
    },
    getDecomposition(n) {
        const s = n.toString();
        const adds = [], muls = [];
        for(let i=0; i<s.length; i++) {
            const d = parseInt(s[i]);
            if (d === 0) continue;
            const p = s.length - 1 - i;
            const val = d * Math.pow(10, p);
            adds.push(val.toLocaleString());
            muls.push(`(${d} x ${Math.pow(10, p).toLocaleString()})`);
        }
        return { adds: adds.join(" + "), muls: muls.join(" + ") };
    }
};

/** 2. ÉTAT **/
let players = 1;
let zones = [];
const OPTION_LABELS = { arabic: "123", roman: "XVI", letters: "ABC", add: "+", mul: "x" };

function initZones(count) {
    zones = Array.from({ length: count }, (_, i) => ({
        id: i,
        cols: new Array(10).fill(0),
        target: 0,
        flipped: false,
        range: 1000,
        mode: 'random', // "Entraînement"
        type: 'arabic',
        timeLeft: 30,
        opts: { arabic: true, roman: true, letters: true, add: true, mul: false }
    }));
    render();
}

/** 3. BOULIER **/
function handleBead(zIdx, colIdx, rowType, beadIdx) {
    const z = zones[zIdx];
    if (z.flipped) return;
    const val = z.cols[colIdx];
    let up = Math.floor(val/5), low = val%5;
    if (rowType === 'up') {
        const clicked = beadIdx + 1;
        up = clicked > up ? clicked : clicked - 1;
    } else {
        const clicked = beadIdx + 1;
        low = clicked > low ? clicked : clicked - 1;
    }
    z.cols[colIdx] = (up * 5) + low;
    render();
}

function calculateValue(cols) {
    return cols.reduce((acc, v, i) => acc + (v * Math.pow(10, 9 - i)), 0);
}

/** 4. ACTIONS **/
function generateChallenge(idx) {
    const z = zones[idx];
    const pool = [];
    if(z.opts.arabic) pool.push('arabic');
    if(z.opts.letters) pool.push('letters');
    if(z.opts.roman) pool.push('roman');
    if(z.opts.add) pool.push('add');
    if(z.opts.mul) pool.push('mul');

    z.type = pool[Math.floor(Math.random() * pool.length)] || 'arabic';
    z.target = Math.floor(Math.random() * (z.range - 1)) + 1;
    if(z.type === 'roman' && z.target > 3999) z.target = 3999;
    
    z.flipped = false;
    z.timeLeft = 30;

    if (z.mode === 'random') {
        z.cols = z.target.toString().padStart(10, '0').split('').map(Number);
    } else {
        z.cols = new Array(10).fill(0);
        if (z.mode === 'dictation') startTimer(idx);
    }
    render();
}

let intervals = {};
function startTimer(idx) {
    if(intervals[idx]) clearInterval(intervals[idx]);
    intervals[idx] = setInterval(() => {
        const z = zones[idx];
        if(!z || z.timeLeft <= 0 || z.flipped) {
            clearInterval(intervals[idx]);
            if(z && z.timeLeft <= 0) { z.flipped = true; render(); }
            return;
        }
        z.timeLeft -= 0.1;
        const bar = document.getElementById(`timer-${idx}`);
        if(bar) bar.style.width = (z.timeLeft / 30 * 100) + "%";
    }, 100);
}

function setNumPlayers(n) {
    players = n;
    ['1','2','4'].forEach(m => {
        const b = document.getElementById(`btn-mode-${m}`);
        if(b) b.className = (m == n) ? "px-5 py-2 rounded-lg text-xs font-black uppercase bg-indigo-600 text-white shadow-lg" : "px-5 py-2 rounded-lg text-xs font-black uppercase text-slate-400 hover:text-white";
    });
    initZones(n);
}

/** 5. RENDU **/
function render() {
    const grid = document.getElementById('main-grid');
    grid.className = `flex-1 p-4 grid gap-6 ${players === 1 ? 'grid-cols-1 max-w-5xl mx-auto w-full' : players === 2 ? 'grid-cols-1 lg:grid-cols-2' : 'grid-cols-1 md:grid-cols-2 xl:grid-cols-4'}`;
    
    grid.innerHTML = zones.map((z, idx) => `
        <div class="card-container ${z.flipped ? 'is-flipped' : ''}">
            <div class="card-inner">
                <div class="card-front bg-white border-4 border-slate-300">
                    <!-- Config (ORDRE EXACT : Entraînement, Duel, Sprint) -->
                    <div class="p-3 bg-slate-50 border-b flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <div class="flex bg-slate-200 p-0.5 rounded-lg gap-0.5 shadow-inner">
                                ${['random','manual','dictation'].map(m => `
                                    <button onclick="zones[${idx}].mode='${m}'; render();" class="px-3 py-1.5 rounded-md text-[9px] font-black uppercase transition-all ${z.mode === m ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:text-slate-800'}">
                                        ${m === 'random' ? 'Entraînement' : m === 'manual' ? 'Duel' : 'Sprint'}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="flex gap-0.5">
                                ${[1000, 10000, 1000000, 1000000000].map(r => `
                                    <button onclick="zones[${idx}].range=${r}; render();" class="w-8 h-7 flex items-center justify-center rounded-md text-[8px] font-black border transition-all ${z.range === r ? 'bg-indigo-600 text-white' : 'bg-white text-slate-400'}">
                                        ${r < 10000 ? r : r === 10000 ? '10k' : (r/1000000)+'M'}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="flex items-center gap-2 bg-white p-1 rounded-lg border-2 border-slate-100">
                            <div class="flex-1 flex gap-1 overflow-x-auto scrollbar-hide px-1">
                                ${Object.entries(z.opts).map(([k,v]) => `
                                    <button onclick="zones[${idx}].opts.${k}=${!v}; render();" class="px-2 py-1 rounded-full text-[8px] font-black uppercase border transition-all ${v ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-slate-50 border-slate-100 text-slate-300'}">
                                        ${OPTION_LABELS[k]}
                                    </button>
                                `).join('')}
                            </div>
                            <button onclick="generateChallenge(${idx})" class="h-8 px-4 bg-indigo-600 text-white rounded-lg font-black text-[10px] uppercase border-b-2 border-indigo-800 shadow-md active:translate-y-1">Lancer</button>
                        </div>
                    </div>

                    <!-- Défi -->
                    <div class="p-3">
                        <div class="bg-slate-900 rounded-2xl p-4 flex flex-col items-center justify-center min-h-[90px] relative overflow-hidden shadow-inner">
                            ${z.mode === 'dictation' && z.target > 0 ? `<div id="timer-${idx}" class="absolute top-0 left-0 h-1.5 bg-emerald-500" style="width:${z.timeLeft/30*100}%"></div>` : ''}
                            <h2 class="text-white text-center font-space font-bold ${players === 4 ? 'text-lg' : 'text-3xl'} break-words w-full tracking-tight">
                                ${z.target === 0 ? 'PRÊT ?' : getChallengeLabel(z)}
                            </h2>
                        </div>
                    </div>

                    <!-- Boulier -->
                    <div class="flex-1 px-4 flex items-center justify-center">
                        <div class="w-full h-full max-h-[350px] bg-[#2d1e12] rounded-[2rem] border-8 border-[#1a120b] shadow-2xl flex p-1.5 overflow-hidden">
                            <div class="flex-1 flex bg-[#fdfaf5] rounded-xl overflow-hidden shadow-inner">
                                ${z.cols.map((v, c) => renderCol(idx, c, v)).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Bas -->
                    <div class="p-4 bg-slate-50 border-t flex gap-3">
                        <button onclick="zones[${idx}].flipped=true; render();" class="flex-[3] h-14 bg-emerald-600 border-b-4 border-emerald-800 text-white rounded-xl font-black text-base uppercase shadow-lg active:translate-y-0.5 active:border-b-0">Corriger</button>
                        <button onclick="zones[${idx}].cols=new Array(10).fill(0); render();" class="flex-1 h-14 bg-white text-red-500 border-2 border-red-50 rounded-xl font-black text-[10px] uppercase shadow-sm">Vider</button>
                    </div>
                </div>

                <!-- CORRECTION CALIBRÉE TBI (AFFICHAGE 3 BLOCS SANS SCROLL) -->
                <div class="card-back border-4 border-dashed border-slate-300 p-5 flex flex-col items-center">
                    <div class="text-center w-full mb-2">
                        <p class="text-slate-400 font-black uppercase text-[9px] tracking-[0.3em] mb-1">Valeur sur le boulier</p>
                        <h3 class="text-6xl font-space font-black tracking-tighter leading-none ${z.target > 0 ? (calculateValue(z.cols) === z.target ? 'text-emerald-500' : 'text-red-500') : 'text-indigo-600'}">
                            ${calculateValue(z.cols).toLocaleString()}
                        </h3>
                        ${z.target > 0 ? `
                            <div class="mt-2 px-6 py-1.5 rounded-full font-black text-lg uppercase shadow-lg inline-block ${calculateValue(z.cols) === z.target ? 'bg-emerald-600 text-white' : 'bg-red-600 text-white'}">
                                ${calculateValue(z.cols) === z.target ? '✓ BRAVO' : '✗ ERREUR'}
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex-1 w-full space-y-2 overflow-y-auto pr-1 scrollbar-hide py-2">
                        ${renderIdentityCard(z)}
                    </div>

                    <button onclick="zones[${idx}].flipped=false; render();" class="mt-3 w-full h-14 bg-slate-900 text-white rounded-xl font-black text-base uppercase shadow-2xl border-b-4 border-slate-950 active:scale-95 transition-transform">Retour</button>
                </div>
            </div>
        </div>
    `).join('');
}

function renderCol(zIdx, cIdx, val) {
    const up = Math.floor(val/5), low = val%5, hasDot = [0,3,6,9].includes(cIdx);
    return `
        <div class="flex-1 flex flex-col items-center relative border-x border-slate-200/10">
            <div class="absolute w-1 h-full bg-gradient-to-r from-slate-400 via-slate-100 to-slate-400 left-1/2 -translate-x-1/2"></div>
            <div class="relative w-full h-[30%] flex flex-col justify-end z-10 px-0.5 pb-1">
                ${[1,0].map(i => `<div onclick="handleBead(${zIdx},${cIdx},'up',${i})" class="bead w-full aspect-[2.4/1] rounded-full shadow-md border border-black/30 ${up > i ? 'bg-red-600' : 'bg-red-950 opacity-80'}" style="transform: translateY(${up > i ? i*2 : -18}px)"></div>`).join('')}
            </div>
            <div class="w-full h-3 bg-[#1a120b] z-30 flex items-center justify-center shadow-inner">${hasDot ? `<div class="w-1.5 h-1.5 bg-white/90 rounded-full shadow-[0_0_5px_white]"></div>` : ''}</div>
            <div class="relative w-full h-[70%] flex flex-col justify-start z-10 px-0.5 pt-1">
                ${[0,1,2,3].map(i => `<div onclick="handleBead(${zIdx},${cIdx},'low',${i})" class="bead w-full aspect-[2.4/1] rounded-full shadow-md border border-black/30 ${low > i ? 'bg-blue-600' : 'bg-blue-950 opacity-80'}" style="transform: translateY(${low > i ? -i*2 : 30}px)"></div>`).join('')}
            </div>
        </div>
    `;
}

function getChallengeLabel(z) {
    if(z.mode === 'random') return z.target.toLocaleString();
    const d = MathUtils.getDecomposition(z.target);
    switch(z.type) {
        case 'roman': return MathUtils.toRoman(z.target);
        case 'letters': return MathUtils.toFrench(z.target);
        case 'add': return d.adds;
        case 'mul': return d.muls;
        default: return z.target.toLocaleString();
    }
}

function renderIdentityCard(z) {
    const val = z.target > 0 ? z.target : calculateValue(z.cols);
    const d = MathUtils.getDecomposition(val);
    let h = "";
    
    const cardClass = "bg-white p-2.5 rounded-xl border-2 border-slate-200 shadow-sm flex flex-col justify-center";
    const titleClass = "text-slate-400 font-black text-[8px] uppercase mb-0.5 tracking-widest leading-none";
    const valueClass = "font-black text-indigo-600 text-2xl font-space leading-tight block";

    if(z.opts.arabic) h += `<div class="${cardClass}"><p class="${titleClass}">Chiffres</p><span class="${valueClass}">${val.toLocaleString()}</span></div>`;
    if(z.opts.roman && val <= 3999) h += `<div class="${cardClass}"><p class="${titleClass}">Romains</p><span class="${valueClass} text-amber-600">${MathUtils.toRoman(val)}</span></div>`;
    if(z.opts.letters) h += `<div class="${cardClass}"><p class="${titleClass}">Lettres</p><span class="font-bold text-slate-800 text-lg leading-tight block">"${MathUtils.toFrench(val)}"</span></div>`;
    if(z.opts.add) h += `<div class="${cardClass}"><p class="${titleClass}">Addition</p><span class="font-black text-indigo-500 text-lg font-space leading-snug block">${d.adds}</span></div>`;
    if(z.opts.mul) h += `<div class="${cardClass}"><p class="${titleClass}">Multiplication</p><span class="font-black text-emerald-600 text-lg font-space leading-snug block">${d.muls}</span></div>`;
        
    return h;
}

// Initialisation au démarrage
initZones(1);
</script>
</body>
</html>
